"use strict";(self.webpackChunkephemeris_notes=self.webpackChunkephemeris_notes||[]).push([[3359],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var r=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=r.createContext({}),m=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=m(e.components);return r.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=m(n),d=i,h=u["".concat(s,".").concat(d)]||u[d]||p[d]||a;return n?r.createElement(h,o(o({ref:t},c),{},{components:n})):r.createElement(h,o({ref:t},c))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var m=2;m<a;m++)o[m]=n[m];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},3037:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>l,toc:()=>m});var r=n(7462),i=(n(7294),n(3905));const a={},o=void 0,l={unversionedId:"ImplementationDetails/Multiplayer/Time Sync",id:"ImplementationDetails/Multiplayer/Time Sync",title:"Time Sync",description:"The game can run at extremely high time speeds (e.g. one day/second = 86400x). That means even tiny error in time synchronisation will be amplified enormously.",source:"@site/docs/ImplementationDetails/Multiplayer/Time Sync.md",sourceDirName:"ImplementationDetails/Multiplayer",slug:"/ImplementationDetails/Multiplayer/Time Sync",permalink:"/EphemerisNotes/ImplementationDetails/Multiplayer/Time Sync",draft:!1,editUrl:"https://github.com/martindevans/EphemerisNotes/tree/master/docs/ImplementationDetails/Multiplayer/Time Sync.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Networking Notes",permalink:"/EphemerisNotes/ImplementationDetails/Multiplayer/Networking"},next:{title:"Naming",permalink:"/EphemerisNotes/ImplementationDetails/Naming"}},s={},m=[{value:"Soft Lockstep",id:"soft-lockstep",level:3},{value:"Lockstep Drift Correction",id:"lockstep-drift-correction",level:2},{value:"Time Control Step By Step",id:"time-control-step-by-step",level:2}],c={toc:m};function p(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"The game can run at extremely high time speeds (e.g. one day/second = 86400x). That means even tiny error in time synchronisation will be amplified enormously."),(0,i.kt)("h3",{id:"soft-lockstep"},"Soft Lockstep"),(0,i.kt)("p",null,"When the server wants to change the sim speed, it sends a message to all clients telling them what sim speed to set and when to set it (with some advance warning). The clients spend the short time ahead of the change tweaking their time speed to get exactly in sync at the moment of the time change."),(0,i.kt)("h2",{id:"lockstep-drift-correction"},"Lockstep Drift Correction"),(0,i.kt)("p",null,'Even after a perfect in-sync change in time speed, client might drift. This can be handled with the same mechanism - simply re-scheduling the current time speed periodically. This acts as a "heartbeat" to keep everyone in sync.'),(0,i.kt)("h2",{id:"time-control-step-by-step"},"Time Control Step By Step"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"A ",(0,i.kt)("inlineCode",{parentName:"li"},"TimeSpeedRequestEvent")," is sent through the event bus",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"From the user clicking a button in the UI"),(0,i.kt)("li",{parentName:"ul"},"From backpressure (overloaded CPU)",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"RailSamplerBackpressure")))))),(0,i.kt)("li",{parentName:"ol"},"Event is received by ",(0,i.kt)("inlineCode",{parentName:"li"},"TimeSyncComms")," and sent up to the server"),(0,i.kt)("li",{parentName:"ol"},"Event is received by ",(0,i.kt)("inlineCode",{parentName:"li"},"TimeSyncComms")," (on server)",(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"Replicated to all clients, stored in ECS"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"TimeSyncComms")," (on server) detects when a change in time speed is needed. Sends a message to all clients scheduling that time change in the near future (in ",(0,i.kt)("inlineCode",{parentName:"li"},"NetworkScheduledGameTimeSimulationHost"),")"),(0,i.kt)("li",{parentName:"ol"},"Every frame ",(0,i.kt)("inlineCode",{parentName:"li"},"NetworkScheduledGameTimeSimulationHost")," checks the next scheduled time change and applies it when necessary")))}p.isMDXComponent=!0}}]);